---
title: "Running Scone with multiple donors"
author: "Tyler J Burns"
date: "October 2, 2017"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Running Scone with multiple donors}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, results = "markup", message = FALSE, warning = FALSE)
knitr::opts_chunk$set(fig.width=6, fig.height=4) 
```
```{r}
library(Sconify)
```

The HowToProcessFCSFiles and TheSconeWorkflow vignettes show pre-processing and analysis for instances where the comparisons being made are across single cells. However, datasets may contain multiple donors or replicates, and the user might want to make comparisons acorss these donors, rather than a pool of single cells. This vignette covers this case. Here, we use data from Fragidakis et al (https://www.ncbi.nlm.nih.gov/pubmed/26655308), where we compare basline versus IL-6 and LPS stimulation conditions, across four healthy human donors. 

We start by reading in the data. We have a vector of fcs files called total.files, which includes fcs files from four donors with the conditions "BL" (baseline), "LPS", and "IL-6." Very important is that the fcs file is in the following format: name__donor__condition. Here is an example name: run1_stims__p104_IL10.fcs. The code searches for the last __ and _ to identify the donor and the condition for the given file respectively, and that information is placed into respective columns in the data matrix. Notice also I set name.multiple.donors to be TRUE. 

Of note, I have already used get.marker.values (see "PreProcessing.Rmd") to obtain the vector of input markers for KNN computation (md.input), and for per-KNN statistics (md.scone). 

```{r}
library(Sconify)
# Markers to be used for KNN computation
md.input

# Markers to be used for per-KNN statistics
md.scone
```

```{r, eval = FALSE}
md <- process.multiple.files(total.files,
                                numcells = 20000,
                                scale = TRUE,
                                input = md.input,
                                name.multiple.donors = TRUE)
```

```{r}
md
```

Now, we find k-nearest neighbors as we normally would. Here, I set the k to 200, as that was the optimal solution for this dataset (see FindingIdealK.Rmd for details)
```{r, eval = FALSE}
md.nn <- fnn(cell.df = md, input.markers = md.input, k = 200)
```

```{r}
str(md.nn)
```

Now, we perform the per-KNN statistics. Notice here that I set unstim to be "BL," as thet is the condition name of the untreated file here, and importantly I set multiple.donor.compare to be TRUE. This allows for the per-donor/per-replicate statistics to be done within each KNN. Note that the output columns are formatted as condition.change, condition.qvalue, and condition.replicate.qvalue for per-cell fold change, per-cell q value, and per-replicate q value, respectively. 

```{r, eval = FALSE}
md.scone.output <- scone.values(nn.matrix = md.nn,
                         cell.data = md,
                         scone.markers = md.scone,
                         unstim = "BL",
                         multiple.donor.compare = TRUE)
```

```{r}
md.scone.output
```

Finally, we do the post-processing step, which includes a t-SNE run that gets added to our final data matrix. 
```{r, eval = FALSE}
md.final <- post.processing(scone.output = md.scone.output,
                            cell.data = md,
                            input = md.input,
                            tsne = TRUE,
                            log.transform.qvalue = TRUE)
```

```{r}
md.final
```

Let's look at an example of a per-donor t-SNE map and its corresponding per-cell t-SNE map. Note that the q values for the per-donor comparisons are not as high as the per-cell comparisons, as expected, because the total number of donors in this case is 4, but the total number of cells per KNN is 200. 

```{r}
library(ggplot2)

# tSNE map colored by q value from comparing replicates in baseline vs LPS conditions
qplot(md.final$`bh-SNE1`, 
      md.final$`bh-SNE2`, 
      color = md.final$P38.LPS.replicate.qvalue, 
      xlab = "bh-SNE1",
      ylab = "bh-SNE2") + 
    labs(color = "LPS -> pP38 per-replicate q value") + 
    scale_color_gradientn(colors = c("black", "yellow")) 

# tSNE map now colored by q value from comparing cells in baseline vs LPS conditions
qplot(md.final$`bh-SNE1`, 
      md.final$`bh-SNE2`, 
      color = md.final$P38.LPS.qvalue, 
      xlab = "bh-SNE1",
      ylab = "bh-SNE2") + 
    labs(color = "LPS -> pP38 per-cell q value") + 
    scale_color_gradientn(colors = c("black", "yellow"))
```




